# Nexus Configuration Example
# Copy this file to nexus.exs and customize for your project

# =============================================================================
# HOSTS
# =============================================================================
# Define individual hosts with user@hostname or user@hostname:port syntax

host :web1, "deploy@192.168.1.10"
host :web2, "deploy@192.168.1.11"
host :web3, "deploy@192.168.1.12:2222"  # Custom SSH port

host :db_primary, "admin@db1.example.com"
host :db_replica, "admin@db2.example.com"

host :staging, "deploy@staging.example.com"

# =============================================================================
# GROUPS
# =============================================================================
# Organize hosts into logical groups for targeted execution

group :web, [:web1, :web2, :web3]
group :database, [:db_primary, :db_replica]
group :production, [:web1, :web2, :web3, :db_primary, :db_replica]

# =============================================================================
# CONFIGURATION
# =============================================================================
# Global settings for Nexus

config :nexus,
  # Default SSH user if not specified in host
  default_user: "deploy",

  # Default SSH port
  default_port: 22,

  # SSH connection timeout (milliseconds)
  connect_timeout: 5_000,

  # Default command timeout (milliseconds)
  command_timeout: 30_000,

  # Maximum SSH connections per host
  max_connections: 10,

  # Continue executing on task failure
  continue_on_error: false

# =============================================================================
# TASKS
# =============================================================================

# -----------------------------------------------------------------------------
# Build Tasks (Local)
# -----------------------------------------------------------------------------

task :deps, on: :local do
  command "mix deps.get"
  command "mix deps.compile"
end

task :compile, on: :local, deps: [:deps] do
  command "mix compile --warnings-as-errors"
end

task :test, on: :local, deps: [:compile] do
  command "mix test"
end

task :build, on: :local, deps: [:test] do
  command "MIX_ENV=prod mix release --overwrite"
end

# -----------------------------------------------------------------------------
# Deployment Tasks
# -----------------------------------------------------------------------------

task :upload, on: :web, deps: [:build] do
  # Upload the release tarball to each web server
  upload "_build/prod/rel/myapp/myapp-*.tar.gz", "/opt/myapp/releases/"
end

task :backup, on: :web do
  # Create backup of current version before deploying
  command "cp -r /opt/myapp/current /opt/myapp/backup-$(date +%Y%m%d-%H%M%S)"
end

task :deploy, on: :web, deps: [:upload, :backup] do
  # Extract and link new release
  command "cd /opt/myapp/releases && tar -xzf myapp-*.tar.gz"
  command "ln -sfn /opt/myapp/releases/myapp /opt/myapp/current"

  # Restart the application
  service "myapp", action: :restart

  # Wait for health check
  wait_for :http, "http://localhost:4000/health", timeout: 30_000
end

task :rollback, on: :web do
  # Quick rollback to previous version
  command "cd /opt/myapp && rm current && mv backup-* current"
  service "myapp", action: :restart
end

# -----------------------------------------------------------------------------
# Database Tasks
# -----------------------------------------------------------------------------

task :migrate, on: :db_primary, deps: [:deploy] do
  command "/opt/myapp/current/bin/myapp eval 'MyApp.Release.migrate()'"
end

task :db_backup, on: :db_primary do
  command "pg_dump myapp_prod > /backups/myapp-$(date +%Y%m%d).sql"
end

# -----------------------------------------------------------------------------
# Utility Tasks
# -----------------------------------------------------------------------------

task :status, on: :production do
  command "systemctl status myapp"
end

task :logs, on: :web do
  command "journalctl -u myapp -n 100 --no-pager"
end

task :disk_check, on: :production do
  command "df -h"
end

task :restart, on: :web do
  service "myapp", action: :restart
end

# -----------------------------------------------------------------------------
# Full Deployment Pipeline
# -----------------------------------------------------------------------------

task :full_deploy, deps: [:deploy, :migrate] do
  # This task has no commands - it just ensures deploy and migrate run
end

# -----------------------------------------------------------------------------
# Staging Deployment
# -----------------------------------------------------------------------------

task :staging_deploy, on: :staging, deps: [:build] do
  upload "_build/prod/rel/myapp/myapp-*.tar.gz", "/opt/myapp/"
  command "cd /opt/myapp && tar -xzf myapp-*.tar.gz"
  service "myapp", action: :restart
end

# =============================================================================
# USAGE EXAMPLES
# =============================================================================
#
# Validate configuration:
#   nexus validate
#
# List all tasks:
#   nexus list
#
# Run pre-flight checks:
#   nexus preflight deploy
#
# Build locally:
#   nexus run build
#
# Deploy to production:
#   nexus run full_deploy
#
# Deploy with dry-run first:
#   nexus run deploy --dry-run
#   nexus run deploy
#
# Check status on all production hosts:
#   nexus run status
#
# View logs with verbose output:
#   nexus run logs --verbose
#
